// LoginPage.ets
import CommonConstants from '../common/Constants';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import preferences from '@ohos.data.preferences';
import md5 from 'js-md5';
import HttpService, { HttpServiceClass } from '../services/HttpService';
import { LoginResponse, LoginDTO } from '../models/dataModels';
import { Result } from '../models/dataModels';
import httpServiceInstance from '../services/HttpService';
import TokenManager from '../utils/TokenManager';
import { GlobalContext } from '../utils/GlobalContext';


@Entry
@Component
struct LoginPage {
  @State username: string = '';
  @State password: string = '';
  @State rememberpwd: boolean = false;
  @State logining: boolean = false;
  private httpService: HttpServiceClass = httpServiceInstance;

  // åˆå§‹åŒ–è®°ä½å¯†ç 
  aboutToAppear() {
    this.getStoredCredentials();
  }

  // è·å–å­˜å‚¨çš„å‡­è¯
  private async getStoredCredentials() {
    try {
      const context = GlobalContext.getInstance().getContext();
      if (!context) {
        console.error('ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–');
        return;
      }

      let pref = await preferences.getPreferences(context, 'userPrefs');

      let storedUser = await pref.get('username', '');
      let storedPwd = await pref.get('password', '');
      if (storedUser && storedPwd) {
        this.username = storedUser.toString();
        this.password = storedPwd.toString();
        this.rememberpwd = true;
      }
    } catch (err) {
      console.error('è·å–å‡­è¯å¤±è´¥: ' + err);
    }
  }

  // æäº¤ç™»å½•è¡¨å•
  private async submitForm() {
    if (!this.validateForm()) return;
    this.logining = true;
    let encryptedPwd: string = md5(md5(this.password) + '_ljcsys');

    try {
      const loginData: LoginDTO = {
        username: this.username,
        password: encryptedPwd
      };

      const result : Result<LoginResponse> = await this.httpService.post<LoginResponse>(CommonConstants.API_LOGIN, loginData);

      if (result.code === 200) {
        await this.handleLoginSuccess(result.data);
      } else {
        promptAction.showToast({ message: result.msg || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ', duration: 2000 });
      }
    } catch (err) {
      this.handleLoginError(err);
    } finally {
      this.logining = false;
    }
  }

  // å¤„ç†ç™»å½•æˆåŠŸ
  private async handleLoginSuccess(data: LoginResponse) {
    await this.storeCredentials();

    // ä½¿ç”¨TokenManagerå­˜å‚¨tokenå’Œç”¨æˆ·ä¿¡æ¯
    await TokenManager.saveToken(data.token, data.username);
    this.httpService.setToken(data.token);

    promptAction.showToast({ message: 'ç™»å½•æˆåŠŸï¼æ¬¢è¿æ‚¨ï¼', duration: 2000 });

    // è·³è½¬åˆ°é¦–é¡µ
    router.pushUrl({
      url: CommonConstants.INDEX_PAGE
    });
  }

  // å¤„ç†ç™»å½•é”™è¯¯
  private handleLoginError(error: Error) {
    console.error('ç™»å½•é”™è¯¯:', error);
    promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', duration: 2000 });
  }

  // å­˜å‚¨å‡­è¯
  private async storeCredentials() {
    try {
      const context = GlobalContext.getInstance().getContext();
      if (!context) {
        console.error('ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–');
        return;
      }

      let pref = await preferences.getPreferences(context, 'userPrefs');

      if (this.rememberpwd) {
        await pref.put('username', this.username);
        await pref.put('password', this.password);
      } else {
        await pref.delete('username');
        await pref.delete('password');
      }
      await pref.flush();
    } catch (err) {
      console.error('å­˜å‚¨å‡­è¯å¤±è´¥:', err);
    }
  }

  // è¡¨å•éªŒè¯
  private validateForm(): boolean {
    if (!this.username.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥è´¦å·', duration: 2000 });
      return false;
    }
    if (!this.password.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¯†ç ', duration: 2000 });
      return false;
    }
    return true;
  }

  build() {
    Stack() {
      // èƒŒæ™¯æ¸å˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 135,
          colors: [['#667eea', 0.0], ['#764ba2', 1.0]]
        })

      // ä¸»è¦å†…å®¹
      Column() {
        // LogoåŒºåŸŸ
        Column() {
          // è£…é¥°æ€§å›¾æ ‡
          Text('ğŸ“')
            .fontSize(60)
            .margin({ bottom: 16 })
          
          // æ ‡é¢˜
          Text('ç­çº§ä¿¡æ¯ä¸­å¿ƒäº‘å¹³å°')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .textShadow({ radius: 2, color: 'rgba(0,0,0,0.3)', offsetX: 1, offsetY: 1 })
            .margin({ bottom: 8 })
          
          // å‰¯æ ‡é¢˜
          Text('æ™ºæ…§æ•™è‚²ï¼Œè¿æ¥æœªæ¥')
            .fontSize(16)
            .fontColor('rgba(255,255,255,0.8)')
            .margin({ bottom: 50 })
        }
        .alignItems(HorizontalAlign.Center)

        // ç™»å½•å¡ç‰‡
        Column() {
          // ç”¨æˆ·åè¾“å…¥æ¡†
          Row() {
            Text('ğŸ‘¤')
              .fontSize(20)
              .fontColor('#666')
              .margin({ right: 12 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥è´¦å·', text: this.username })
              .layoutWeight(1)
              .height(50)
              .backgroundColor('transparent')
              .border({ width: 0 })
              .fontSize(16)
              .placeholderColor('#999')
              .onChange(value => this.username = value)
          }
          .width('100%')
          .height(50)
          .backgroundColor('#F8F9FA')
          .borderRadius(25)
          .padding({ left: 20, right: 20 })
          .margin({ bottom: 16 })
          .shadow({
            radius: 8,
            color: 'rgba(0,0,0,0.1)',
            offsetX: 0,
            offsetY: 2
          })

          // å¯†ç è¾“å…¥æ¡†
          Row() {
            Text('ğŸ”’')
              .fontSize(20)
              .fontColor('#666')
              .margin({ right: 12 })
            
            TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ', text: this.password })
              .layoutWeight(1)
              .height(50)
              .backgroundColor('transparent')
              .border({ width: 0 })
              .fontSize(16)
              .type(InputType.Password)
              .placeholderColor('#999')
              .onChange(value => this.password = value)
          }
          .width('100%')
          .height(50)
          .backgroundColor('#F8F9FA')
          .borderRadius(25)
          .padding({ left: 20, right: 20 })
          .margin({ bottom: 20 })
          .shadow({
            radius: 8,
            color: 'rgba(0,0,0,0.1)',
            offsetX: 0,
            offsetY: 2
          })

          // è®°ä½å¯†ç 
          Row() {
            Checkbox()
              .select(this.rememberpwd)
              .selectedColor('#667eea')
              .unselectedColor('#DDD')
              .onChange(value => this.rememberpwd = value)
            
            Text('è®°ä½å¯†ç ')
              .fontSize(14)
              .fontColor('#666')
              .margin({ left: 8 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 30 })

          // ç™»å½•æŒ‰é’®
          Button(this.logining ? 'ç™»å½•ä¸­...' : 'ç™»å½•')
            .width('100%')
            .height(50)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .backgroundColor(this.logining ? '#CCC' : '#667eea')
            .borderRadius(25)
            .shadow({
              radius: 12,
              color: this.logining ? 'rgba(0,0,0,0.1)' : 'rgba(102,126,234,0.4)',
              offsetX: 0,
              offsetY: 4
            })
            .onClick(() => this.submitForm())
            .enabled(!this.logining)
            .animation({
              duration: 200,
              curve: Curve.EaseInOut
            })
        }
        .width('85%')
        .padding({ top: 40, bottom: 40, left: 30, right: 30 })
        .backgroundColor('#FFFFFF')
        .borderRadius(20)
        .shadow({
          radius: 20,
          color: 'rgba(0,0,0,0.15)',
          offsetX: 0,
          offsetY: 8
        })
        .margin({ top: 20 })

        // åº•éƒ¨è£…é¥°
        Text('Â© 2024 ç­çº§ä¿¡æ¯ä¸­å¿ƒäº‘å¹³å°')
          .fontSize(12)
          .fontColor('rgba(255,255,255,0.6)')
          .margin({ top: 40 })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .padding({ left: 20, right: 20 })
    }
    .width('100%')
    .height('100%')
  }
}